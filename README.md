# Financial Simulation Portal

This repository contains a minimal multi-tenant financial simulation portal composed of:

- **PHP 8+ REST API** (`api/`, `src/`, `public/`)
- **Python WebSocket server** (`websocket/server.py`) broadcasting institution-scoped events
- **Vanilla HTML/CSS/JS frontend** (`public/`)
- **MariaDB schema** (`sql/schema.sql`)

## Project structure

```
public/              # Static pages + front controller
api/                 # PHP endpoints
src/                 # Shared PHP services (Database, Auth, etc.)
config/env.php       # Environment configuration loader
websocket/server.py  # Async WebSocket broadcaster + admin HTTP endpoint
sql/schema.sql       # MariaDB schema
```

## Setup

1. **Install dependencies**
   - PHP 8+ with PDO MySQL extension
   - Python 3.10+ with `websockets` and `aiohttp`
   - MariaDB/MySQL

2. **Database**
   - Create a database and run `sql/schema.sql`.
   - Insert institutions, users, and stocks scoped by `institution_id`.

3. **Configure environment**
   - Copy `config/env.php` defaults and adjust via environment variables:
     - `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS`
     - `SESSION_NAME`
     - `WS_PUBLIC_URL` (public `wss://` hostname served through Cloudflare Tunnel)
     - `WS_ADMIN_TOKEN`, `WS_BROADCAST_URL`
   - Point `WS_BROADCAST_URL` to the admin endpoint of the Python server (default `http://127.0.0.1:8766/admin/broadcast`).

4. **Run the WebSocket server**
   ```bash
   pip install websockets aiohttp
   python websocket/server.py
   ```
   The server binds to `127.0.0.1:8787` (WebSocket) and `127.0.0.1:8766` (admin HTTP), which can be exposed publicly via a Cloudflare Tunnel.

5. **Run the PHP API/front end**
   ```bash
   php -S localhost:8000 -t public
   ```
   Endpoints live under `/api/*.php` (e.g., `http://localhost:8000/api/institutions.php`).

6. **Login flows**
   - Local accounts use `/api/auth_login.php`.
   - Google OAuth URL is generated by `/api/auth_google_url.php` per institution (callback stub in `public/auth_google_callback.php`).

## Notable flows

- **Multi-tenancy**: Each query filters by `institution_id` and sessions store `user_id` + `institution_id` to prevent cross-institution access.
- **Trading**: `TradeService` handles buy/sell and short opens; `api/shorts_close.php` can be called via cron to settle expired shorts.
- **Manager actions**: Manage stocks, publish crisis scenarios, and push real-time price updates that are broadcast via the WebSocket server.
- **Real-time**: Managers trigger `BroadcastService::send()` which posts to the Python admin endpoint; clients subscribe via `/ws?institution_id=...`.

## Security notes

- Passwords rely on `password_hash`/`password_verify`.
- OAuth flow is simplified for demonstration; production deployments must exchange auth codes securely and validate tokens and email domains.
- Consider HTTPS, CSRF protection, stricter validation, and rate limiting for production.
